<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RSVP Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/css/styles.css" />
  <style>
    body { background: #0f1116; color: #e6e6e6; }
    .table thead { background: rgba(255, 159, 189, 0.12); }
    .badge-yes { background: #198754; }
    .badge-maybe { background: #ffc107; color: #111; }
    .badge-no { background: #dc3545; }
    .card { background: #161a23; border: 1px solid rgba(255,255,255,0.08); }
    .pill { border-radius: 999px; padding: 2px 10px; font-size: 0.8rem; border: 1px solid rgba(255,255,255,0.08); }
  </style>
</head>
<body>
  <%- include('partials/nav', { navLinks: [{ href: '/admin', text: 'Admin', active: true }], brandHref: '/admin' }) %>
  <div class="container py-5" style="margin-top: 8rem;">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <p class="text-uppercase text-muted small mb-1">RSVP Dashboard</p>
        <h1 class="h4 mb-0">RSVP Admin</h1>
      </div>
      <div class="d-flex gap-2">
        <span class="pill text-muted">Protected</span>
        <span class="pill" id="guestCountPill">Guests: --</span>
        <span class="pill" id="roomCountPill">Rooms: --</span>
      </div>
    </div>
    <div id="status" class="alert alert-info">Loading responses…</div>
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm table-dark align-middle" id="rsvpTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Email</th>
                <th>Attendance</th>
                <th>Guests</th>
                <th>Room</th>
                <th>Room Count</th>
                <th>Plus Ones</th>
                <th>Allergies</th>
                <th>Song</th>
                <th>Message</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header">
          <h5 class="modal-title">Edit RSVP</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editForm" class="row g-3">
            <input type="hidden" id="editId" />
            <div class="col-md-6">
              <label class="form-label">Full Name *</label>
              <input type="text" class="form-control" id="editName" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Email *</label>
              <input type="email" class="form-control" id="editEmail" required />
            </div>
            <div class="col-md-4">
              <label class="form-label">Attendance *</label>
              <select class="form-select" id="editAttendance" required>
                <option value="yes">Yes</option>
                <option value="maybe">Maybe</option>
                <option value="no">No</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Guest Count *</label>
              <input type="number" min="0" class="form-control" id="editGuests" required />
            </div>
            <div class="col-md-4">
              <label class="form-label">Song Request</label>
              <input type="text" class="form-control" id="editSong" />
            </div>
            <div class="col-12">
              <label class="form-label">Message</label>
              <textarea class="form-control" rows="2" id="editMessage"></textarea>
            </div>
            <div class="col-md-6">
              <label class="form-label">Plus One Names</label>
              <input type="text" class="form-control" id="editPlusOnes" placeholder="Comma-separated names" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Food Allergies</label>
              <input type="text" class="form-control" id="editAllergies" placeholder="Text or JSON" />
              <div class="form-text text-muted">If JSON is provided, it will be stored as-is.</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Needs Room?</label>
              <select class="form-select" id="editNeedsRoom">
                <option value="false">No</option>
                <option value="true">Yes</option>
              </select>
              <div class="form-text">Rooms are 1000 PHP or $25/night.</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Room Count</label>
              <input type="number" min="0" class="form-control" id="editRoomCount" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <div id="editStatus" class="text-danger small me-auto"></div>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveEditBtn">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <%- include('partials/footer') %>

  <script>
    var editModal;
    var rsvpRows = new Map();

    function badge(att) {
      if (att === "yes") return '<span class="badge badge-yes">Yes</span>';
      if (att === "maybe") return '<span class="badge badge-maybe">Maybe</span>';
      if (att === "no") return '<span class="badge badge-no">No</span>';
      return att || "";
    }

    function fmtPlusNames(row) {
      return row.plus_one_names || "";
    }

    function fmtRoom(row) {
      return row.needs_room ? "Yes" : "No";
    }

    function fmtRoomCount(row) {
      return row.needs_room ? (row.room_count || 0) : 0;
    }

    function fmtAllergies(row) {
      if (!row.food_allergies) return "";
      if (Array.isArray(row.food_allergies)) {
        return row.food_allergies
          .map(function (g) {
            return g.name ? g.name + (g.allergies ? " (" + g.allergies + ")" : "") : g.allergies;
          })
          .filter(Boolean)
          .join("; ");
      }
      return row.food_allergies;
    }

    async function loadData() {
      var status = document.getElementById("status");
      status.className = "alert alert-info";
      status.textContent = "Loading responses…";
      try {
        var res = await fetch("/admin/data");
        var data = await res.json();
        if (!res.ok) throw new Error(data.error || "Failed to load");
        status.className = "visually-hidden";
        if (data.totals && typeof data.totals.total !== "undefined") {
          var pill = document.getElementById("guestCountPill");
          var roomPill = document.getElementById("roomCountPill");
          if (pill) {
            pill.textContent = "Expected: " + (data.totals.yes || 0) + " (Yes) / " + (data.totals.total || 0) + " (All)";
          }
          if (roomPill) {
            roomPill.textContent = "Rooms: " + (data.totals.roomReservations || 0) + " / People: " + (data.totals.roomGuests || 0);
          }
        }
        var tbody = document.querySelector("#rsvpTable tbody");
        tbody.innerHTML = "";
        rsvpRows.clear();
        data.rows.forEach(function (row) {
          rsvpRows.set(row.id, row);
          var tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.id}</td>
            <td>${row.full_name}</td>
            <td>${row.email}</td>
            <td>${badge(row.attendance)}</td>
            <td>${row.guest_count}</td>
            <td>${fmtRoom(row)}</td>
            <td>${fmtRoomCount(row)}</td>
            <td>${fmtPlusNames(row)}</td>
            <td>${fmtAllergies(row)}</td>
            <td>${row.song_request || ""}</td>
            <td>${row.message || ""}</td>
            <td>${row.created_at || ""}</td>
            <td class="text-nowrap">
              <button class="btn btn-sm btn-outline-light edit-btn" data-id="${row.id}">Edit</button>
              <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${row.id}">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        status.className = "alert alert-danger mt-3";
        status.textContent = err.message;
      }
    }

    async function deleteRsvp(id) {
      var status = document.getElementById("status");
      try {
        var res = await fetch("/admin/rsvp/" + id, { method: "DELETE" });
        var data = await res.json();
        if (!res.ok) throw new Error(data.error || "Delete failed");
        status.className = "alert alert-success mt-3";
        status.textContent = "RSVP deleted.";
        await loadData();
      } catch (err) {
        status.className = "alert alert-danger mt-3";
        status.textContent = err.message;
      }
    }

    function openEdit(id) {
      var row = rsvpRows.get(Number(id));
      if (!row) return;
      document.getElementById("editId").value = row.id;
      document.getElementById("editName").value = row.full_name || "";
      document.getElementById("editEmail").value = row.email || "";
      document.getElementById("editAttendance").value = (row.attendance || "yes").toLowerCase();
      document.getElementById("editGuests").value = row.guest_count || 0;
      document.getElementById("editSong").value = row.song_request || "";
      document.getElementById("editMessage").value = row.message || "";
      document.getElementById("editPlusOnes").value = row.plus_one_names || "";
      var allergyField = document.getElementById("editAllergies");
      if (Array.isArray(row.food_allergies)) {
        allergyField.value = JSON.stringify(row.food_allergies);
      } else {
        allergyField.value = row.food_allergies || "";
      }
      document.getElementById("editNeedsRoom").value = row.needs_room ? "true" : "false";
      document.getElementById("editRoomCount").value = row.room_count || 0;
      var status = document.getElementById("editStatus");
      status.textContent = "";
      var modalEl = document.getElementById("editModal");
      editModal = editModal || new bootstrap.Modal(modalEl);
      editModal.show();
    }

    async function saveEdit() {
      var status = document.getElementById("editStatus");
      status.textContent = "";
      var id = document.getElementById("editId").value;
      var payload = {
        full_name: document.getElementById("editName").value.trim(),
        email: document.getElementById("editEmail").value.trim(),
        attendance: document.getElementById("editAttendance").value,
        guest_count: Number(document.getElementById("editGuests").value || 0),
        song_request: document.getElementById("editSong").value.trim(),
        message: document.getElementById("editMessage").value.trim(),
        plus_one_names: document.getElementById("editPlusOnes").value.trim(),
        food_allergies: document.getElementById("editAllergies").value.trim(),
        needs_room: document.getElementById("editNeedsRoom").value === "true",
        room_count: Number(document.getElementById("editRoomCount").value || 0),
      };
      try {
        var res = await fetch("/admin/rsvp/" + id, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        var data = await res.json();
        if (!res.ok) throw new Error(data.error || "Update failed");
        if (editModal) editModal.hide();
        await loadData();
        var mainStatus = document.getElementById("status");
        mainStatus.className = "alert alert-success mt-3";
        mainStatus.textContent = "RSVP updated.";
      } catch (err) {
        status.textContent = err.message;
      }
    }

    document.addEventListener("click", function (e) {
      var delBtn = e.target.closest(".delete-btn");
      if (delBtn) {
        var id = delBtn.getAttribute("data-id");
        if (!id) return;
        var confirmed = window.confirm("Delete this RSVP? This cannot be undone.");
        if (!confirmed) return;
        deleteRsvp(id);
        return;
      }
      var editBtn = e.target.closest(".edit-btn");
      if (editBtn) {
        var editId = editBtn.getAttribute("data-id");
        if (!editId) return;
        openEdit(editId);
      }
    });

    document.getElementById("saveEditBtn").addEventListener("click", saveEdit);

    loadData();
  </script>
</body>
</html>
